---
title: redis
date: 2025-09-22 01:44:36
tags:
  - java

---

# RedisåŸºç¡€

[Redis](https://redis.io/) ï¼ˆ**RE**mote **DI**ctionary **S**erverï¼‰æ˜¯ä¸€ä¸ªåŸºäº C è¯­è¨€å¼€å‘çš„å¼€æº NoSQL æ•°æ®åº“ï¼ˆBSD è®¸å¯ï¼‰ã€‚ä¸ä¼ ç»Ÿæ•°æ®åº“ä¸åŒçš„æ˜¯ï¼ŒRedis çš„æ•°æ®æ˜¯ä¿å­˜åœ¨å†…å­˜ä¸­çš„ï¼ˆå†…å­˜æ•°æ®åº“ï¼Œæ”¯æŒæŒä¹…åŒ–ï¼‰ï¼Œå› æ­¤è¯»å†™é€Ÿåº¦éå¸¸å¿«ï¼Œè¢«å¹¿æ³›åº”ç”¨äºåˆ†å¸ƒå¼ç¼“å­˜æ–¹å‘ã€‚å¹¶ä¸”ï¼ŒRedis å­˜å‚¨çš„æ˜¯ KV é”®å€¼å¯¹æ•°æ®ã€‚

ä¸ºäº†æ»¡è¶³ä¸åŒçš„ä¸šåŠ¡åœºæ™¯ï¼ŒRedis å†…ç½®äº†å¤šç§æ•°æ®ç±»å‹å®ç°ï¼ˆæ¯”å¦‚ Stringã€Hashã€Sorted Setã€Bitmapã€HyperLogLogã€GEOï¼‰ã€‚å¹¶ä¸”ï¼ŒRedis è¿˜æ”¯æŒäº‹åŠ¡ã€æŒä¹…åŒ–ã€Lua è„šæœ¬ã€å‘å¸ƒè®¢é˜…æ¨¡å‹ã€å¤šç§å¼€ç®±å³ç”¨çš„é›†ç¾¤æ–¹æ¡ˆï¼ˆRedis Sentinelã€Redis Clusterï¼‰ã€‚

## Redisçš„æ•°æ®ç±»å‹



1. **Stringï¼ˆå­—ç¬¦ä¸²ï¼‰**
   - äºŒè¿›åˆ¶å®‰å…¨ï¼Œå¯ä»¥å­˜å‚¨ä»»æ„æ•°æ®ï¼šå­—ç¬¦ä¸²ã€æ•°å­—ã€ç”šè‡³å›¾ç‰‡æˆ–åºåˆ—åŒ–æ•°æ®ã€‚
   - æœ€å¤§å®¹é‡ï¼šå•ä¸ª value æœ€å¤š 512MBã€‚
   - å¸¸è§æ“ä½œï¼š`SET`ã€`GET`ã€`INCR`ã€`DECR`ã€`APPEND`ã€‚
   - ä½¿ç”¨åœºæ™¯ï¼šç¼“å­˜å¯¹è±¡ã€è®¡æ•°å™¨ã€åˆ†å¸ƒå¼é”ã€‚
2. **Listï¼ˆåˆ—è¡¨ï¼‰**
   - ä¸€ä¸ªæœ‰åºçš„åŒå‘é“¾è¡¨ï¼Œå¯ä»¥ä»ä¸¤ç«¯æ’å…¥å’Œå¼¹å‡ºå…ƒç´ ã€‚
   - ä¿æŒæ’å…¥é¡ºåºï¼Œæ”¯æŒé‡å¤å…ƒç´ ã€‚
   - å¸¸è§æ“ä½œï¼š`LPUSH`ã€`RPUSH`ã€`LPOP`ã€`RPOP`ã€`LRANGE`ã€‚
   - ä½¿ç”¨åœºæ™¯ï¼šæ¶ˆæ¯é˜Ÿåˆ—ã€ä»»åŠ¡é˜Ÿåˆ—ã€æœ€æ–°åˆ—è¡¨å±•ç¤ºï¼ˆå¦‚å¾®åšæ—¶é—´çº¿ï¼‰ã€‚
3. **Hashï¼ˆå“ˆå¸Œè¡¨ï¼‰**
   - å­˜å‚¨é”®å€¼å¯¹ï¼ˆfield-valueï¼‰ï¼Œé€‚åˆå­˜å‚¨å¯¹è±¡ã€‚
   - å¸¸è§æ“ä½œï¼š`HSET`ã€`HGET`ã€`HMGET`ã€`HDEL`ã€‚
   - ä½¿ç”¨åœºæ™¯ï¼šç”¨æˆ·ä¿¡æ¯è¡¨ï¼ˆid â†’ {name, age, email}ï¼‰ã€‚
4. **Setï¼ˆé›†åˆï¼‰**
   - æ— åºé›†åˆï¼Œä¸å…è®¸é‡å¤ã€‚
   - åº•å±‚å®ç°ï¼šå“ˆå¸Œè¡¨ï¼ŒæŸ¥æ‰¾å’Œå»é‡æ•ˆç‡é«˜ã€‚
   - å¸¸è§æ“ä½œï¼š`SADD`ã€`SMEMBERS`ã€`SINTER`ã€`SUNION`ã€`SDIFF`ã€‚
   - ä½¿ç”¨åœºæ™¯ï¼šå»é‡ã€å¥½å‹å…³ç³»ï¼ˆäº¤é›†æ±‚å…±åŒå¥½å‹ï¼Œå·®é›†æ±‚å¯èƒ½è®¤è¯†çš„äººï¼‰ã€‚
5. **Sorted Setï¼ˆæœ‰åºé›†åˆï¼ŒZsetï¼‰**
   - æ¯ä¸ªæˆå‘˜ï¼ˆmemberï¼‰å…³è”ä¸€ä¸ªåˆ†æ•°ï¼ˆscoreï¼‰ï¼ŒæŒ‰åˆ†æ•°æ’åºã€‚
   - åˆ†æ•°å¯ä»¥ç›¸åŒï¼Œä½†æˆå‘˜ä¸èƒ½é‡å¤ã€‚
   - å¸¸è§æ“ä½œï¼š`ZADD`ã€`ZRANGE`ã€`ZREVRANGE`ã€`ZRANK`ã€`ZREM`ã€‚
   - ä½¿ç”¨åœºæ™¯ï¼šæ’è¡Œæ¦œï¼ˆæŒ‰åˆ†æ•°ã€æ—¶é—´æ’åºï¼‰ã€å¸¦æƒé‡çš„æ•°æ®ã€‚

6. **Bitmapï¼ˆä½å›¾ï¼‰**

- åŸºäº String çš„ä½æ“ä½œï¼ŒèŠ‚çœå­˜å‚¨ç©ºé—´ã€‚
- å¸¸è§æ“ä½œï¼š`SETBIT`ã€`GETBIT`ã€`BITCOUNT`ã€‚
- ä½¿ç”¨åœºæ™¯ï¼šç­¾åˆ°æ‰“å¡ã€ç”¨æˆ·åœ¨çº¿çŠ¶æ€ç»Ÿè®¡ã€å¸ƒéš†è¿‡æ»¤å™¨åº•å±‚ã€‚

7. **HyperLogLog**

- ç”¨äºåŸºæ•°ç»Ÿè®¡ï¼ˆå»é‡è®¡æ•°ï¼‰ï¼Œå ç”¨ç©ºé—´å›ºå®šï¼ˆ12KBï¼‰ã€‚
- å¸¸è§æ“ä½œï¼š`PFADD`ã€`PFCOUNT`ã€`PFMERGE`ã€‚
- ä½¿ç”¨åœºæ™¯ï¼šç½‘ç«™ UV ç»Ÿè®¡ã€æ´»è·ƒç”¨æˆ·æ•°ã€‚

8. **Geospatialï¼ˆåœ°ç†ç©ºé—´æ•°æ®ï¼‰**

- åŸºäº Zset å®ç°ï¼Œå¯ä»¥å­˜å‚¨ç»çº¬åº¦å¹¶è¿›è¡ŒèŒƒå›´æŸ¥è¯¢ã€‚
- å¸¸è§æ“ä½œï¼š`GEOADD`ã€`GEODIST`ã€`GEORADIUS`ã€‚
- ä½¿ç”¨åœºæ™¯ï¼šé™„è¿‘çš„äººã€åœ°å›¾æœåŠ¡ã€‚

9. **Streamï¼ˆæµï¼ŒRedis 5.0 å¼•å…¥ï¼‰**

- æ¶ˆæ¯é˜Ÿåˆ—ç»“æ„ï¼Œæ”¯æŒæŒä¹…åŒ–å’Œæ¶ˆè´¹ç»„ã€‚
- å¸¸è§æ“ä½œï¼š`XADD`ã€`XREAD`ã€`XGROUP`ã€`XREADGROUP`ã€‚
- ä½¿ç”¨åœºæ™¯ï¼šæ¶ˆæ¯é˜Ÿåˆ—ã€æ—¥å¿—ç³»ç»Ÿã€å®æ—¶æ•°æ®å¤„ç†ã€‚

| ç±»å‹        | æ˜¯å¦æœ‰åº | æ˜¯å¦å…è®¸é‡å¤ | å…¸å‹åœºæ™¯         |
| ----------- | -------- | ------------ | ---------------- |
| String      | å¦       | å¦           | ç¼“å­˜ã€è®¡æ•°å™¨ã€é” |
| List        | æœ‰åº     | å…è®¸         | é˜Ÿåˆ—ã€æ—¶é—´çº¿     |
| Hash        | æ— åº     | field å”¯ä¸€   | å­˜å‚¨å¯¹è±¡ä¿¡æ¯     |
| Set         | æ— åº     | å¦           | å»é‡ã€é›†åˆè¿ç®—   |
| Sorted Set  | æœ‰åº     | å¦           | æ’è¡Œæ¦œ           |
| Bitmap      | ä½åºåˆ—   | ä½å”¯ä¸€       | ç­¾åˆ°ã€çŠ¶æ€æ ‡è®°   |
| HyperLogLog | N/A      | æ¦‚ç‡å»é‡     | UV ç»Ÿè®¡          |
| Geo         | æŒ‰è·ç¦»   | å¦           | åœ°ç†ä½ç½®æœåŠ¡     |
| Stream      | æœ‰åº     | å…è®¸         | æ¶ˆæ¯é˜Ÿåˆ—         |

## redisæ•ˆèƒ½

1. çº¯å†…å­˜æ“ä½œï¼šæ‰€æœ‰è¯»å†™å‘ç”Ÿåœ¨å†…å­˜ä¸­ï¼Œè€ŒéæŒä¹…åŒ–åˆ°ç£ç›˜ä¸Šã€‚
2. é«˜æ•ˆçš„IOæ¨¡å‹ï¼šé‡‡ç”¨äº†å•çº¿ç¨‹äº‹ä»¶ä»¥åŠIOå¤šè·¯å¤ç”¨ã€‚
3. ä¼˜åŒ–çš„å†…éƒ¨æ•°æ®ç»“æ„ï¼šå¦‚ziplistï¼Œquicklistï¼Œskiplistï¼Œhashtable
4. é‡‡ç”¨äº†è‡ªå®šä¹‰çš„é€šä¿¡åè®®ï¼šRESP

## å…¶ä»–çš„åˆ†å¸ƒå¼ç¼“å­˜æŠ€æœ¯

### Memcached

## Tendis

## Dragonfly

## keyDB

## Faster



# Rediså¸¸è§é—®é¢˜



## é—®ä»€ä¹ˆè¦ç”¨åˆ†å¸ƒå¼ç¼“å­˜

| ç‰¹æ€§         | æœ¬åœ°ç¼“å­˜                             | Redis                            |
| ------------ | ------------------------------------ | -------------------------------- |
| æ•°æ®ä¸€è‡´æ€§   | å¤šæœåŠ¡å™¨éƒ¨ç½²æ—¶å­˜åœ¨æ•°æ®ä¸ä¸€è‡´é—®é¢˜     | æ•°æ®ä¸€è‡´                         |
| å†…å­˜é™åˆ¶     | å—é™äºå•å°æœåŠ¡å™¨å†…å­˜                 | ç‹¬ç«‹éƒ¨ç½²ï¼Œå†…å­˜ç©ºé—´æ›´å¤§           |
| æ•°æ®ä¸¢å¤±é£é™© | æœåŠ¡å™¨å®•æœºæ•°æ®ä¸¢å¤±                   | å¯æŒä¹…åŒ–ï¼Œæ•°æ®ä¸æ˜“ä¸¢å¤±           |
| ç®¡ç†ç»´æŠ¤     | åˆ†æ•£ï¼Œç®¡ç†ä¸ä¾¿                       | é›†ä¸­ç®¡ç†ï¼Œæä¾›ä¸°å¯Œçš„ç®¡ç†å·¥å…·     |
| åŠŸèƒ½ä¸°å¯Œæ€§   | åŠŸèƒ½æœ‰é™ï¼Œé€šå¸¸åªæä¾›ç®€å•çš„é”®å€¼å¯¹å­˜å‚¨ | åŠŸèƒ½ä¸°å¯Œï¼Œæ”¯æŒå¤šç§æ•°æ®ç»“æ„å’ŒåŠŸèƒ½ |

## å¸¸è§çš„ç¼“å­˜æ›´æ–°ç­–ç•¥æœ‰å“ªäº›

### Cache Aside(æ—è·¯ç¼“å­˜)

å†™æµç¨‹ï¼š

1. æ›´æ–°DB
2. åˆ é™¤ç¼“å­˜

è¯»æµç¨‹ï¼š

1. æŸ¥ç¼“å­˜ï¼Œå‘½ä¸­ç›´æ¥è¿”å›ï¼Œæœªå‘½ä¸­è½¬2
2. æŸ¥æ•°æ®åº“
3. æ›´æ–°ç¼“å­˜

**ä¸ºä»€ä¹ˆå†™æµç¨‹ä¸èƒ½å…ˆåˆ é™¤åæ›´æ–°ï¼Ÿ**

#### åœºæ™¯å¤ç°ï¼ˆå…ˆåˆ é™¤åå†™ï¼‰

1. **çº¿ç¨‹ A**ï¼šåˆ é™¤ç¼“å­˜ã€‚
2. **çº¿ç¨‹ B**ï¼šè¯»å–æ•°æ®ï¼Œå‘ç°ç¼“å­˜æ²¡äº†ï¼Œå»æŸ¥æ•°æ®åº“ï¼Œè¯»åˆ°çš„æ˜¯æ—§å€¼ã€‚
3. **çº¿ç¨‹ A**ï¼šæ›´æ–°æ•°æ®åº“ã€‚
4. **çº¿ç¨‹ B**ï¼šæŠŠæ—§å€¼å†™å›ç¼“å­˜ã€‚

ğŸ‘‰ ç»“æœï¼š**ç¼“å­˜é‡Œæ˜¯æ—§å€¼**ï¼Œæ•°æ®åº“é‡Œæ˜¯æ–°å€¼ï¼Œç¼“å­˜å’Œæ•°æ®åº“ä¸ä¸€è‡´ã€‚

#### åœºæ™¯å¤ç°ï¼ˆå…ˆå†™ååˆ é™¤ï¼‰

1. **çº¿ç¨‹ A**ï¼šæ›´æ–°æ•°æ®åº“ã€‚
2. **çº¿ç¨‹ B**ï¼šè¯»å–æ•°æ®ï¼Œå‘ç°ç¼“å­˜å­˜åœ¨ï¼Œç›´æ¥è¿”å›æ—§å€¼ã€‚
3. **çº¿ç¨‹ A**ï¼šåˆ é™¤ç¼“å­˜ã€‚
4. **çº¿ç¨‹ C**ï¼šè¯»å–æ•°æ®ï¼Œå‘ç°ç¼“å­˜ä¸å­˜åœ¨ï¼Œå»æ•°æ®åº“é‡Œé¢æŸ¥æ•°æ®åº“ï¼Œç„¶åæ›´æ–°ç¼“å­˜ã€‚

ğŸ‘‰ ç»“æœï¼šåˆ°çº¿ç¨‹Bæ—¶**ç¼“å­˜ä¸ºç©º**ï¼Œæ•°æ®åº“é‡Œæ˜¯æ–°å€¼ï¼Œç¼“å­˜å’Œæ•°æ®åº“**çŸ­æš‚**ä¸ä¸€è‡´ï¼ŒçŸ­æš‚ä¸ä¸€è‡´åœ¨åç»­çº¿ç¨‹Cæ—¶ä¼šæ›´æ–°ç¼“å­˜ä¿è¯**æœ€ç»ˆä¸€è‡´æ€§**ã€‚

#### åœºæ™¯å¤ç°ï¼ˆå…ˆå†™ååˆ é™¤ä¾æ—§æœ‰é—®é¢˜ï¼‰

1. **çº¿ç¨‹ A**ï¼šè¯»å–æ•°æ®ï¼Œä½†æ•°æ®ä¸åœ¨ç¼“å­˜ä¸­ï¼Œå»æ•°æ®åº“ä¸­è¯»å–åˆ°æ—§æ•°æ®ã€‚
2. **çº¿ç¨‹ B**ï¼šå†™æ•°æ®åº“ã€‚
3. **çº¿ç¨‹ B**ï¼šåˆ é™¤ç¼“å­˜ã€‚
4. **çº¿ç¨‹ A**ï¼šæ›´æ–°ç¼“å­˜ä¸ºæ—§æ•°æ®ã€‚

ğŸ‘‰ ç»“æœï¼šæ­¤æ—¶ä»ç„¶ä¼šå‡ºç°ç¼“å­˜å’ŒDBæ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µã€‚

#### ä¼˜åŒ–æ‰‹æ®µ

å»¶è¿ŸåŒåˆ ï¼šä¸ºäº†è§£å†³çŸ­æš‚çš„ä¸ä¸€è‡´æ€§ï¼Œæ›´æ–°æ•°æ®åº“åï¼šå…ˆå†™æ•°æ®åº“â†’ åˆ ç¼“å­˜ â†’ sleep ä¸€æ®µæ—¶é—´ â†’ å†åˆ ä¸€æ¬¡ç¼“å­˜ï¼Œèƒ½å¤Ÿè§£å†³å¹¶å‘è¯»å†™å¯¼è‡´çš„è„æ•°æ®ã€‚ç¡®ä¿ç¬¬äºŒæ¬¡åˆ é™¤èƒ½å¤Ÿè¦†ç›–æ‰€æœ‰æ—§æ•°æ®çš„ç¼“å­˜ã€‚

- ä¼˜ç‚¹ï¼š
  - é€‚åˆç¼“å­˜ä¸€è‡´æ€§è¦æ±‚é«˜ï¼Œä½†æ— æ³•æ»¡è¶³å®Œå…¨å®æ—¶ä¸€è‡´æ€§ã€‚

- ç¼ºç‚¹ï¼š
  - å¢åŠ ç³»ç»Ÿå¤æ‚åº¦ã€‚
  - æ— æ³•æ»¡è¶³ä¼šå®Œå…¨å®æ—¶ä¸€è‡´æ€§çš„åœºæ™¯ã€‚

**ç¼ºç‚¹1**ï¼š**è§£å†³é¦–æ¬¡è¯·æ±‚æ•°æ®ä¸€å®šä¸åœ¨ cache çš„é—®é¢˜**ï¼Œå°†çƒ­ç‚¹æ•°æ®æå‰æ”¾å…¥redisä¸­ã€‚

**ç¼ºç‚¹2**ï¼š

æ•°æ®åº“å’Œç¼“å­˜æ•°æ®å¼ºä¸€è‡´åœºæ™¯ï¼šæ›´æ–° db çš„æ—¶å€™åŒæ ·æ›´æ–° cacheï¼Œä¸è¿‡æˆ‘ä»¬éœ€è¦åŠ ä¸€ä¸ªé”/åˆ†å¸ƒå¼é”æ¥ä¿è¯æ›´æ–° cache çš„æ—¶å€™ä¸å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚

å¯ä»¥çŸ­æš‚åœ°å…è®¸æ•°æ®åº“å’Œç¼“å­˜æ•°æ®ä¸ä¸€è‡´çš„åœºæ™¯ï¼šæ›´æ–° db çš„æ—¶å€™åŒæ ·æ›´æ–° cacheï¼Œä½†æ˜¯ç»™ç¼“å­˜åŠ ä¸€ä¸ªæ¯”è¾ƒçŸ­çš„è¿‡æœŸæ—¶é—´ï¼Œè¿™æ ·çš„è¯å°±å¯ä»¥ä¿è¯å³ä½¿æ•°æ®ä¸ä¸€è‡´çš„è¯å½±å“ä¹Ÿæ¯”è¾ƒå°ã€‚

### Read Through Pattern è¯»ç©¿é€

è¯»ï¼š

1. æŸ¥ç¼“å­˜ï¼Œå‘½ä¸­ç›´æ¥è¿”å›ï¼Œæœªå‘½ä¸­è½¬2
2. æŸ¥æ•°æ®åº“ï¼Œæ›´æ–°ç¼“å­˜ï¼Œè¿”å›æ•°æ®åº“



### Write Through Patternï¼ˆå†™ç©¿é€ï¼‰

å†™ï¼š

1. å…ˆæŸ¥cacheï¼Œcacheä¸å­˜åœ¨ï¼Œç›´æ¥æ›´æ–°db
2. cacheä¸­å­˜åœ¨ï¼Œå…ˆæ›´æ–°cacheï¼Œ**åŒæ­¥**æ›´æ–°DBï¼ˆç¼“å­˜å’ŒDBåœ¨åŒä¸€äº‹åŠ¡ä¸­å†™ï¼‰

Read-Through Pattern å®é™…åªæ˜¯åœ¨ Cache-Aside Pattern ä¹‹ä¸Šè¿›è¡Œäº†å°è£…ã€‚åœ¨ Cache-Aside Pattern ä¸‹ï¼Œå‘ç”Ÿè¯»è¯·æ±‚çš„æ—¶å€™ï¼Œå¦‚æœ cache ä¸­ä¸å­˜åœ¨å¯¹åº”çš„æ•°æ®ï¼Œæ˜¯ç”±å®¢æˆ·ç«¯è‡ªå·±è´Ÿè´£æŠŠæ•°æ®å†™å…¥ cacheï¼Œè€Œ Read Through Pattern åˆ™æ˜¯ cache æœåŠ¡è‡ªå·±æ¥å†™å…¥ç¼“å­˜çš„ï¼Œè¿™å¯¹å®¢æˆ·ç«¯æ˜¯é€æ˜çš„ã€‚

> å®é™…ä¸Šrediså¹¶ä¸æä¾›è¯»å†™ç©¿é€çš„ç­–ç•¥ï¼Œredisè‡ªå·±æ— æ³•å»å†™DB

### Read Back ï¼ˆå†™å›ï¼‰

å†™ï¼š

1. å…ˆæŸ¥cacheï¼Œcacheä¸å­˜åœ¨ï¼Œç›´æ¥æ›´æ–°db
2. cacheä¸­å­˜åœ¨ï¼Œå…ˆæ›´æ–°cacheï¼Œ**å¼‚æ­¥**æ›´æ–°DB

ä¼˜ç‚¹ï¼š

â€‹	å‡å°‘æ•°æ®åº“å‹åŠ›

ç¼ºç‚¹ï¼š

â€‹	æ•°æ®ä¸¢å¤±é£é™©ï¼ˆç¼“å­˜å®•æœºï¼Œæ•°æ®æ²¡è½åº“ï¼‰ã€‚

â€‹	ä¸€è‡´æ€§è¾ƒå¼±ï¼Œé€‚åˆå¯¹ä¸€è‡´æ€§è¦æ±‚ä¸é«˜çš„åœºæ™¯ã€‚



# Redisåº•å±‚ç»“æ„ä»¥åŠå®ç°

Redisæ˜¯**å•çº¿ç¨‹äº‹ä»¶é©±åŠ¨**çš„å†…å­˜æ•°æ®åº“ï¼Œä¸»è¦æ¡†æ¶

```
å®¢æˆ·ç«¯ <-> ç½‘ç»œäº‹ä»¶æ¨¡å— <-> å‘½ä»¤è§£ææ¨¡å— <-> æ•°æ®ç»“æ„æ¨¡å— <-> æŒä¹…åŒ–æ¨¡å—
```

| æ¨¡å—                  | åŠŸèƒ½                                     |
| --------------------- | ---------------------------------------- |
| **ç½‘ç»œ I/O**          | åŸºäº epoll çš„ Reactor æ¨¡å‹ï¼Œéé˜»å¡ I/O   |
| **å‘½ä»¤è§£æå™¨**        | è§£æå®¢æˆ·ç«¯è¯·æ±‚ï¼ˆRESP åè®®ï¼‰              |
| **æ•°æ®ç»“æ„æ¨¡å—**      | å®ç°å„ç§ç±»å‹çš„é”®å€¼å¯¹                     |
| **æŒä¹…åŒ–æ¨¡å—**        | RDB / AOF                                |
| **å†…å­˜ç®¡ç†**          | è‡ªå®šä¹‰å†…å­˜åˆ†é…ï¼ˆjemallocï¼‰               |
| **å¤šçº¿ç¨‹æ¨¡å—ï¼ˆI/Oï¼‰** | åªåœ¨è¯»å†™ç½‘ç»œæ—¶ç”¨å¤šçº¿ç¨‹ï¼Œæ ¸å¿ƒé€»è¾‘ä»å•çº¿ç¨‹ |



## åº•å±‚ç»“æ„

Redisçš„æ‰€æœ‰`key-value`éƒ½ä¿å­˜åœ¨å…¨å±€å“ˆå¸Œè¡¨é‡Œé¢ï¼š

```
dict *db
```

æ¯ä¸ª`key-value`éƒ½æ˜¯ä¸€ä¸ª`dictEntry`ï¼š

```
typedef struct dictEntry {
    void *key;
    void *val;
    struct dictEntry *next;
} dictEntry;

```

> å½“å‡ºç°å“ˆå¸Œå†²çªæ—¶ï¼Œå½¢æˆé“¾è¡¨

`val`æ˜¯ä¸€ä¸ª`redisObject`ç»“æ„ï¼Œæœ‰ä¸åŒçš„ç¼–ç æ–¹å¼ï¼š

```
typedef struct redisObject {
    unsigned type:4;  // æ•°æ®ç±»å‹ (string/list/set/zset/hash)
    unsigned encoding:4; // ç¼–ç æ–¹å¼
    void *ptr;        // æŒ‡å‘åº•å±‚æ•°æ®ç»“æ„
} robj;

```

| Redis ç±»å‹                 | åº•å±‚ç»“æ„ï¼ˆencodingï¼‰                        | è¯´æ˜                                                  |
| -------------------------- | ------------------------------------------- | ----------------------------------------------------- |
| **String**                 | SDSï¼ˆç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼‰                       | ç±»ä¼¼ `char*`ï¼Œä½†æœ‰ lengthã€é¢„åˆ†é…ç©ºé—´ï¼Œæ”¯æŒäºŒè¿›åˆ¶å®‰å…¨ |
| **List**                   | `ziplist`ï¼ˆæ—§ï¼‰ / `quicklist`ï¼ˆæ–°ï¼‰         | åŒç«¯é“¾è¡¨ + å‹ç¼©å—ï¼Œå…¼é¡¾éšæœºè®¿é—®å’Œå†…å­˜æ•ˆç‡             |
| **Hash**                   | `ziplist`ï¼ˆå°ï¼‰ / `hashtable`ï¼ˆå¤§ï¼‰         | å°æ•°æ®ç´§å‡‘å­˜å‚¨ï¼Œå¤§æ•°æ®ç”¨å“ˆå¸Œè¡¨                        |
| **Set**                    | `intset`ï¼ˆå°ï¼‰ / `hashtable`ï¼ˆå¤§ï¼‰          | å°é›†åˆç”¨æ•´æ•°æ•°ç»„ï¼Œå¤§é›†åˆç”¨å“ˆå¸Œè¡¨                      |
| **ZSetï¼ˆæœ‰åºé›†åˆï¼‰**       | `ziplist`ï¼ˆå°ï¼‰ / `skiplist` + `dict`ï¼ˆå¤§ï¼‰ | è·³è¡¨ + å“ˆå¸Œè¡¨ï¼Œæ”¯æŒæŒ‰åˆ†æ•°èŒƒå›´æŸ¥è¯¢                     |
| Stream                     | radix tree+list pack                        |                                                       |
| Bitmap                     | String                                      | ä½æ“ä½œåœ¨Stringä¸Šå®ç°                                  |
| HyperLog Log               | ç¨€ç–/ç¨ å¯†æ•°ç»„ + hash                        |                                                       |
| Geo                        | Zset+GeoHash                                |                                                       |
| Bloom Filterï¼ˆå¸ƒéš†è¿‡æ»¤å™¨ï¼‰ | bitmap+hash                                 |                                                       |

### String(SDS)

Redisçš„å­—ç¬¦ä¸²ä¸æ˜¯char*è€Œæ˜¯

```
struct sdshdr {
    int len;       // å®é™…é•¿åº¦
    int alloc;     // åˆ†é…ç©ºé—´
    char buf[];    // å†…å®¹
};

```

### ListåŒç«¯é“¾è¡¨

#### ZipList

åœ¨Redis<3.2ï¼šä½¿ç”¨`ziplist`å‹ç¼©è¡¨

ZipListåˆ’åˆ†ä¸ºå¤šä¸ªå­—æ®µ

![img](https://raw.githubusercontent.com/yicizhang00/image_host/main/blog-img/20251014150145645.png)

- 1ã€**zlbytes**ï¼šå‹ç¼©åˆ—è¡¨çš„å­—èŠ‚é•¿åº¦ï¼Œå 4ä¸ªå­—èŠ‚ï¼Œå› æ­¤å‹ç¼©åˆ—è¡¨æœ€é•¿(2^32)-1å­—èŠ‚ï¼›
- 2ã€**zltail**ï¼šå‹ç¼©åˆ—è¡¨å°¾å…ƒç´ ç›¸å¯¹äºå‹ç¼©åˆ—è¡¨èµ·å§‹åœ°å€çš„åç§»é‡ï¼Œå 4ä¸ªå­—èŠ‚ï¼›
- 3ã€**zllen**ï¼šå‹ç¼©åˆ—è¡¨çš„å…ƒç´ æ•°ç›®ï¼Œå ä¸¤ä¸ªå­—èŠ‚ï¼›é‚£ä¹ˆå½“å‹ç¼©åˆ—è¡¨çš„å…ƒç´ æ•°ç›®è¶…è¿‡(2^16)-1æ€ä¹ˆå¤„ç†å‘¢ï¼Ÿæ­¤æ—¶é€šè¿‡zllenå­—æ®µæ— æ³•è·å¾—å‹ç¼©åˆ—è¡¨çš„å…ƒç´ æ•°ç›®ï¼Œå¿…é¡»éå†æ•´ä¸ªå‹ç¼©åˆ—è¡¨æ‰èƒ½è·å–åˆ°å…ƒç´ æ•°ç›®ï¼›
- 4ã€**entryX**ï¼šå‹ç¼©åˆ—è¡¨å­˜å‚¨çš„è‹¥å¹²ä¸ªå…ƒç´ ï¼Œå¯ä»¥ä¸ºå­—èŠ‚æ•°ç»„æˆ–è€…æ•´æ•°ï¼›entryçš„ç¼–ç ç»“æ„åé¢è¯¦è¿°ï¼›
- 5ã€**zlend**ï¼šå‹ç¼©åˆ—è¡¨çš„ç»“å°¾ï¼Œå ä¸€ä¸ªå­—èŠ‚ï¼Œæ’ä¸º**0xFF**ã€‚

ä¾‹å¦‚

![img](https://raw.githubusercontent.com/yicizhang00/image_host/main/blog-img/20251014150219950.jpeg)

ä»£è¡¨è¿™ä¸ªziplistçš„æ€»ç©ºé—´å¤§å°ä¸º0x50ï¼Œåˆ°å°¾éƒ¨çš„åç§»é‡ä¸º0x3c(0d60)ï¼Œå³æœ€åä¸€ä¸ªentry3çš„åœ°å€ä¸ºp+60ï¼Œæ•°ç»„é•¿åº¦ä¸º0x3ï¼Œæœ€åä¸€ä¸ªå­—èŠ‚é»˜è®¤ä¸º0xFFã€‚

æ¯ä¸ªå‹ç¼©åˆ—è¡¨èŠ‚ç‚¹çš„å…·ä½“æ„æˆä¸º

![img](https://raw.githubusercontent.com/yicizhang00/image_host/main/blog-img/20251014150446605.jpeg)

- previous_entry_lengthï¼šè¿™ä¸ªå±æ€§è®°å½•äº†å‹ç¼©åˆ—è¡¨å‰ä¸€ä¸ªèŠ‚ç‚¹çš„é•¿åº¦ï¼Œ**è¯¥å±æ€§æ ¹æ®å‰ä¸€ä¸ªèŠ‚ç‚¹çš„å¤§å°ä¸åŒå¯ä»¥æ˜¯1ä¸ªå­—èŠ‚æˆ–è€…5ä¸ªå­—èŠ‚ã€‚**
  - å¦‚æœå‰ä¸€ä¸ªèŠ‚ç‚¹çš„é•¿åº¦å°äº254ä¸ªå­—èŠ‚ï¼Œé‚£ä¹ˆprevious_entry_lengthçš„å¤§å°ä¸º1ä¸ªå­—èŠ‚ï¼Œ**å³å‰ä¸€ä¸ªèŠ‚ç‚¹çš„é•¿åº¦å¯ä»¥ä½¿ç”¨1ä¸ªå­—èŠ‚è¡¨ç¤ºã€‚**
  - å¦‚æœå‰ä¸€ä¸ªèŠ‚ç‚¹çš„é•¿åº¦å¤§äºç­‰äº254ä¸ªå­—èŠ‚ï¼Œé‚£ä¹ˆprevious_entry_lengthçš„å¤§å°ä¸º5ä¸ªå­—èŠ‚**ï¼Œç¬¬ä¸€ä¸ªå­—èŠ‚ä¼šè¢«è®¾ç½®ä¸º0xFE(åè¿›åˆ¶çš„254ï¼‰ï¼Œä¹‹åçš„å››ä¸ªå­—èŠ‚åˆ™ç”¨äºä¿å­˜å‰ä¸€ä¸ªèŠ‚ç‚¹çš„é•¿åº¦ã€‚**

![](https://raw.githubusercontent.com/yicizhang00/image_host/main/blog-img/20251014150815811.jpeg)ã€![img](https://raw.githubusercontent.com/yicizhang00/image_host/main/blog-img/20251014150828183.jpeg)

è¯¥å­—æ®µè®¾è®¡ä¸»è¦æ˜¯ä¸ºäº†æŸ¥æ‰¾å‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä½¿ç”¨å½“å‰èŠ‚ç‚¹çš„åœ°å€å‡å»å‰ä¸€ä¸ªèŠ‚ç‚¹çš„é•¿åº¦å³å¯è·å¾—å‰ä¸€ä¸ªèŠ‚ç‚¹çš„å¼€å§‹åœ°å€ã€‚

- encodingï¼šè¡¨ç¤ºcontentçš„ç¼–ç æ–¹å¼ä»¥åŠé•¿åº¦ï¼Œ
  - ä¸€å­—èŠ‚ã€ä¸¤å­—èŠ‚æˆ–è€…äº”å­—èŠ‚é•¿ï¼Œ å€¼çš„æœ€é«˜ä½ä¸º 00 ã€ 01 æˆ–è€… 10 çš„æ˜¯å­—èŠ‚æ•°ç»„ç¼–ç ï¼š è¿™ç§ç¼–ç è¡¨ç¤ºèŠ‚ç‚¹çš„ content å±æ€§ä¿å­˜ç€å­—èŠ‚æ•°ç»„ï¼Œ æ•°ç»„çš„é•¿åº¦ç”±ç¼–ç é™¤å»æœ€é«˜ä¸¤ä½ä¹‹åçš„å…¶ä»–ä½è®°å½•
  - ä¸€å­—èŠ‚é•¿ï¼Œ å€¼çš„æœ€é«˜ä½ä»¥ 11 å¼€å¤´çš„æ˜¯æ•´æ•°ç¼–ç ï¼š è¿™ç§ç¼–ç è¡¨ç¤ºèŠ‚ç‚¹çš„ content å±æ€§ä¿å­˜ç€æ•´æ•°å€¼ï¼Œ æ•´æ•°å€¼çš„ç±»å‹å’Œé•¿åº¦ç”±ç¼–ç é™¤å»æœ€é«˜ä¸¤ä½ä¹‹åçš„å…¶ä»–ä½è®°å½•ï¼›

![image-20251014151052722](https://raw.githubusercontent.com/yicizhang00/image_host/main/blog-img/20251014151053014.png)

- contentï¼šå†…å®¹æ ¹æ®encodingéƒ¨åˆ†å†³å®šã€‚

![image-20251014151141782](https://raw.githubusercontent.com/yicizhang00/image_host/main/blog-img/20251014151141865.png)



#### è¿é”æ›´æ–°

ç”±äºprevious_entry_lenthçš„é•¿åº¦æ˜¯åŠ¨æ€å˜åŒ–çš„ï¼Œå› æ­¤æ·»åŠ èŠ‚ç‚¹æˆ–è€…åˆ é™¤èŠ‚ç‚¹æ—¶å¯èƒ½ä¼šå¯¼è‡´åä¸€ä¸ªèŠ‚ç‚¹çš„é•¿åº¦å˜åŒ–

![image-20251014151910166](https://raw.githubusercontent.com/yicizhang00/image_host/main/blog-img/20251014151910361.png)**å³ä½¿å­˜åœ¨è¿™ç§æƒ…å†µï¼Œä½†æ˜¯å¹¶ä¸å½±å“æˆ‘ä»¬ä½¿ç”¨å‹ç¼©åˆ—è¡¨**

å‹ç¼©åˆ—è¡¨é‡Œè¦æ°å¥½æœ‰å¤šä¸ª**è¿ç»­çš„ã€é•¿åº¦ä»‹äº 250 å­—èŠ‚è‡³ 253 å­—èŠ‚ä¹‹é—´çš„èŠ‚ç‚¹ï¼Œ è¿é”æ›´æ–°æ‰æœ‰å¯èƒ½è¢«å¼•å‘ï¼Œ è¿™ç§æƒ…å†µå°±å’Œè¿ä¸­å½©ç¥¨ä¸€æ ·ï¼Œå¾ˆå°‘è§ (yes æ‡‚äº†)**

å³ä½¿å‡ºç°è¿é”æ›´æ–°ï¼Œ ä½†åªè¦è¢«æ›´æ–°çš„èŠ‚ç‚¹æ•°é‡ä¸å¤šï¼Œ å°±ä¸ä¼šå¯¹æ€§èƒ½é€ æˆä»»ä½•å½±å“ï¼š æ¯”å¦‚è¯´ï¼Œ å¯¹ä¸‰äº”ä¸ªèŠ‚ç‚¹è¿›è¡Œè¿é”æ›´æ–°æ˜¯ç»å¯¹ä¸ä¼šå½±å“æ€§èƒ½çš„ï¼›

#### ç‰¹ç‚¹

- ç»“æ„ç´§å‡‘ï¼šä¸€æ•´å—è¿ç»­å†…å­˜ï¼Œæ²¡æœ‰å¤šä½™çš„å†…å­˜ç¢ç‰‡ï¼Œæ›´æ–°ä¼šå¯¼è‡´å†…å­˜ realloc ä¸å†…å­˜å¤åˆ¶ï¼Œå¹³å‡æ—¶é—´å¤æ‚åº¦ä¸º `O(N)`
- **é€†å‘éå†ï¼šä»è¡¨å°¾å¼€å§‹å‘è¡¨å¤´è¿›è¡Œéå†(æ³¨æ„äº†ï¼ï¼Œä½†æ˜¯æ’å…¥è¿˜æ˜¯åœ¨è¡¨å¤´)**
- è¿é”æ›´æ–°ï¼šå¯¹å‰ä¸€æ¡æ•°æ®çš„æ›´æ–°ï¼Œå¯èƒ½å¯¼è‡´åä¸€æ¡æ•°æ®çš„ prev_entry_length ä¸ encoding æ‰€éœ€é•¿åº¦å˜åŒ–ï¼Œäº§ç”Ÿè¿é”ååº”ï¼Œæ›´æ–°æ“ä½œæœ€åæ—¶é—´ä¸º `O(N^2)`

#### QuickList

åœ¨è¾ƒæ—©ç‰ˆæœ¬çš„ redis ä¸­ï¼Œlist æœ‰ä¸¤ç§åº•å±‚å®ç°ï¼š

- **å½“åˆ—è¡¨å¯¹è±¡ä¸­å…ƒç´ çš„é•¿åº¦æ¯”è¾ƒå°æˆ–è€…æ•°é‡æ¯”è¾ƒå°‘çš„æ—¶å€™ï¼Œé‡‡ç”¨å‹ç¼©åˆ—è¡¨ ziplist æ¥å­˜å‚¨**
- **å½“åˆ—è¡¨å¯¹è±¡ä¸­å…ƒç´ çš„é•¿åº¦æ¯”è¾ƒå¤§æˆ–è€…æ•°é‡æ¯”è¾ƒå¤šçš„æ—¶å€™ï¼Œåˆ™ä¼šè½¬è€Œä½¿ç”¨åŒå‘åˆ—è¡¨ linkedlist æ¥å­˜å‚¨**

ä¸¤è€…å„æœ‰ä¼˜ç¼ºç‚¹ï¼š

- **ziplist çš„ä¼˜ç‚¹æ˜¯å†…å­˜ç´§å‡‘ï¼Œè®¿é—®æ•ˆç‡é«˜ï¼Œç¼ºç‚¹æ˜¯æ›´æ–°æ•ˆç‡ä½ï¼Œå¹¶ä¸”æ•°æ®é‡è¾ƒå¤§æ—¶ï¼Œå¯èƒ½å¯¼è‡´å¤§é‡çš„å†…å­˜å¤åˆ¶**
- **linkedlist çš„ä¼˜ç‚¹æ˜¯èŠ‚ç‚¹ä¿®æ”¹çš„æ•ˆç‡é«˜ï¼Œä½†æ˜¯éœ€è¦é¢å¤–çš„å†…å­˜å¼€é”€ï¼Œå¹¶ä¸”èŠ‚ç‚¹è¾ƒå¤šæ—¶ï¼Œä¼šäº§ç”Ÿå¤§é‡çš„å†…å­˜ç¢ç‰‡**

ä¸ºäº†ç»“åˆä¸¤è€…çš„ä¼˜ç‚¹ï¼Œ**åœ¨ redis 3.2 ä¹‹åï¼Œlist çš„åº•å±‚å®ç°å˜ä¸ºå¿«é€Ÿåˆ—è¡¨ quicklist**ã€‚
å¿«é€Ÿåˆ—è¡¨æ˜¯ linkedlist ä¸ ziplist çš„ç»“åˆ: quicklist åŒ…å«å¤šä¸ªå†…å­˜ä¸è¿ç»­çš„èŠ‚ç‚¹ï¼Œä½†æ¯ä¸ªèŠ‚ç‚¹æœ¬èº«å°±æ˜¯ä¸€ä¸ª ziplistã€‚



åœ¨Redisï¼3.2ï¼šä½¿ç”¨é“¾è¡¨å’Œ`ziplist`ç»“åˆçš„`quickList`

#### quickListNodeç»“æ„

```c
typedef struct quicklistNode {
    struct quicklistNode *prev;  //å‰ä¸€ä¸ªquicklistNode
    struct quicklistNode *next;  //åä¸€ä¸ªquicklistNode
    unsigned char *zl;           //quicklistNodeæŒ‡å‘çš„ziplist
    unsigned int sz;             //ziplistçš„å­—èŠ‚å¤§å°
    unsigned int count : 16;     //ziplistä¸­çš„å…ƒç´ ä¸ªæ•°
    unsigned int encoding : 2;   //ç¼–ç æ ¼å¼ï¼ŒåŸç”Ÿå­—èŠ‚æ•°ç»„æˆ–å‹ç¼©å­˜å‚¨
    unsigned int container : 2;  //å­˜å‚¨æ–¹å¼
    unsigned int recompress : 1; //æ•°æ®æ˜¯å¦è¢«å‹ç¼©
    unsigned int attempted_compress : 1; //æ•°æ®èƒ½å¦è¢«å‹ç¼©
    unsigned int extra : 10;     //é¢„ç•™çš„bitä½
} quicklistNode;

```

prevã€nextæŒ‡å‘è¯¥èŠ‚ç‚¹çš„å‰åèŠ‚ç‚¹ï¼›

zlæŒ‡å‘è¯¥èŠ‚ç‚¹å¯¹åº”çš„ziplistç»“æ„ï¼›

szä»£è¡¨æ•´ä¸ªziplistç»“æ„çš„å¤§å°ï¼›

encodingä»£è¡¨é‡‡ç”¨çš„ç¼–ç æ–¹å¼ï¼š1ä»£è¡¨æ˜¯åŸç”Ÿçš„ï¼Œ2ä»£è¡¨ä½¿ç”¨LZFè¿›è¡Œå‹ç¼©ï¼›

containerä¸ºquicklistNodeèŠ‚ç‚¹zlæŒ‡å‘çš„å®¹å™¨ç±»å‹ï¼š1ä»£è¡¨none,2ä»£è¡¨ä½¿ç”¨ziplistå­˜å‚¨æ•°æ®

recompressä»£è¡¨è¿™ä¸ªèŠ‚ç‚¹ä¹‹å‰æ˜¯å¦æ˜¯å‹ç¼©èŠ‚ç‚¹ï¼Œè‹¥æ˜¯ï¼Œåˆ™åœ¨ä½¿ç”¨å‹ç¼©èŠ‚ç‚¹å‰å…ˆè¿›è¡Œè§£å‹ç¼©ï¼Œä½¿ç”¨åéœ€è¦é‡æ–°å‹ç¼©ï¼Œæ­¤å¤–ä¸º1ï¼Œä»£è¡¨æ˜¯å‹ç¼©èŠ‚ç‚¹ï¼›

attempted_compressæµ‹è¯•æ—¶ä½¿ç”¨ï¼›

extraä¸ºé¢„ç•™

#### quickList

```
typedef struct quicklist {
    quicklistNode *head;   // quicklistçš„é“¾è¡¨å¤´
    quicklistNode *tail;   // quicklistçš„é“¾è¡¨å°¾
    unsigned long count;   // æ‰€æœ‰ziplistä¸­çš„æ€»å…ƒç´ ä¸ªæ•°
    unsigned long len;     // quicklistNodesçš„ä¸ªæ•°
    int fill : QL_FILL_BITS;  // å•ç‹¬è§£é‡Š
    unsigned int compress : QL_COMP_BITS; // å…·ä½“å«ä¹‰æ˜¯ä¸¤ç«¯å„æœ‰compressä¸ªèŠ‚ç‚¹ä¸å‹ç¼©
    ...
} quicklist;

```

fillç”¨æ¥æŒ‡æ˜æ¯ä¸ªquicklistNodeä¸­ziplisté•¿åº¦ï¼Œå½“fillä¸ºæ­£æ•°æ—¶ï¼Œè¡¨æ˜æ¯ä¸ªziplistæœ€å¤šå«æœ‰çš„æ•°æ®é¡¹æ•°ï¼Œå½“fillä¸ºè´Ÿæ•°æ—¶ï¼Œå¦‚ä¸‹ï¼š

- Length -1: 4kï¼Œå³ziplistèŠ‚ç‚¹æœ€å¤§ä¸º4KB
- Length -2: 8kï¼Œå³ziplistèŠ‚ç‚¹æœ€å¤§ä¸º8KB
- Length -3: 16k ...
- Length -4: 32k
- Length -5: 64k

fillå–è´Ÿæ•°æ—¶ï¼Œå¿…é¡»å¤§äºç­‰äº-5ã€‚å¯ä»¥é€šè¿‡Redisä¿®æ”¹å‚æ•°list-max-ziplist-sizeé…ç½®èŠ‚ç‚¹æ‰€å å†…å­˜å¤§å°ã€‚å®é™…ä¸Šæ¯ä¸ªziplistèŠ‚ç‚¹æ‰€å çš„å†…å­˜ä¼šåœ¨è¯¥å€¼ä¸Šä¸‹æµ®åŠ¨ã€‚

è€ƒè™‘quicklistNodeèŠ‚ç‚¹ä¸ªæ•°è¾ƒå¤šæ—¶ï¼Œæˆ‘ä»¬ç»å¸¸è®¿é—®çš„æ˜¯ä¸¤ç«¯çš„æ•°æ®ï¼Œä¸ºäº†è¿›ä¸€æ­¥èŠ‚çœç©ºé—´ï¼ŒRediså…è®¸å¯¹ä¸­é—´çš„quicklistNodeèŠ‚ç‚¹è¿›è¡Œå‹ç¼©ï¼Œé€šè¿‡ä¿®æ”¹å‚æ•°list-compress-depthè¿›è¡Œé…ç½®ï¼Œå³è®¾ç½®compresså‚æ•°ï¼Œè¯¥é¡¹çš„å…·ä½“å«ä¹‰æ˜¯ä¸¤ç«¯å„æœ‰compressä¸ªèŠ‚ç‚¹ä¸å‹ç¼©ã€‚

#### quicklistæ€»ä½“ç»“æ„

![img](https://raw.githubusercontent.com/yicizhang00/image_host/main/blog-img/20251014161710528.webp)

```
QuickList
 â”œâ”€â”€ quicklistNode1 â†’ ziplist1 [a, b, c, d, e]
 â”œâ”€â”€ quicklistNode2 â†’ ziplist2 [f, g, h, i, j]
 â””â”€â”€ quicklistNode3 â†’ ziplist3 [k, l, m, n]

```

**åªæœ‰å½“å‰ quicklistNode çš„ ziplist å·²æ»¡**ï¼ˆè¶…è¿‡è®¾å®šé˜ˆå€¼ï¼‰æ—¶ï¼Œæ‰ä¼šæ–°å»ºä¸€ä¸ª quicklistNodeï¼ˆåŠå…¶ ziplistï¼‰ï¼›
 å¦åˆ™å°±ç›´æ¥å¾€å½“å‰èŠ‚ç‚¹çš„ ziplist é‡Œè¿½åŠ ã€‚

#### åˆ†è£‚æœºåˆ¶

å¦‚æœåœ¨ ziplist **ä¸­é—´æ’å…¥** å…ƒç´ ï¼Œå¯¼è‡´è¶…å‡ºå®¹é‡ä¸Šé™ï¼Œ
 Redis ä¼šå°†è¯¥ ziplist ä¸€åˆ†ä¸ºäºŒï¼š

```
åŸ ziplist: [a, b, c, d, e]
æ’å…¥æ–°å…ƒç´  'X' ä¸­é—´åè¿‡å¤§ï¼š
åˆ†è£‚ä¸ºï¼š
ziplist1: [a, b, X]
ziplist2: [c, d, e]
```

äºæ˜¯ä¼šæ–°å»ºä¸€ä¸ª `quicklistNode` ç”¨äºç¬¬äºŒä¸ª ziplistã€‚
 è¿™æ ·é¿å…æŸä¸ª ziplist å¤ªå¤§å½±å“æ€§èƒ½ã€‚

#### åˆå¹¶æœºåˆ¶

å½“æŸä¸ªziplistå› ä¸ºåˆ é™¤è¿‡å°æ—¶ï¼Œå…¶ä¼šå’Œç›¸é‚»çš„zipliståˆå¹¶ï¼Œä»¥å‡å°‘å†…å­˜ä½¿ç”¨ã€‚



#### listpack

ç”±äºä½¿ç”¨ziplistå¯èƒ½ä¼šå¯¼è‡´ï¼š

- æ¯ä¸ª entry çš„é•¿åº¦å­—æ®µï¼ˆprevlenï¼‰éœ€è¦æ›´æ–°ï¼›

- å¯èƒ½å¼•å‘æ•´ä¸ª ziplist å†…å­˜é‡åˆ†é…ï¼›

- åœ¨æç«¯æƒ…å†µä¸‹æ˜¯ **O(nÂ²)** çš„å¤æ‚åº¦ï¼Œæ‰€æœ‰èŠ‚ç‚¹éƒ½éœ€è¦æ›´æ–°ã€‚

å› æ­¤åœ¨redis7.0ä¹‹åä½¿ç”¨äº†listpackå½»åº•ä»£æ›¿äº†ziplist

å…¶ç»“æ„å¦‚ä¸‹ï¼š

![img](https://raw.githubusercontent.com/yicizhang00/image_host/main/blog-img/20251014163041375.jpeg)

ç›¸å¯¹æ¯”ziplistï¼Œå»é™¤äº†zltailèŠ‚ç‚¹ï¼Œæ„å‘³ç€æ²¡æ³•é€šè¿‡O(1)æ‰¾åˆ°åˆ—è¡¨ç»“å°¾ã€‚å…¶ä¸»è¦æ”¹è¿›åœ¨ListPackEntryä¸­ã€‚

#### ListPackEntry





## Redisçš„åŠŸèƒ½

### åˆ†å¸ƒå¼é”



### é™æµ



### æ¶ˆæ¯é˜Ÿåˆ—



### å»¶æ—¶é˜Ÿåˆ—



### åˆ†å¸ƒå¼Session



### å…¶ä»–ä¸šåŠ¡åœºæ™¯



# Redisçš„æ€§èƒ½

## å•çº¿ç¨‹

Redisä½¿ç”¨äº†å¤šè·¯å¤ç”¨IOæ¥å¤„ç†è¯·æ±‚ï¼Œ

Redis çš„æ ¸å¿ƒå‘½ä»¤æ‰§è¡Œé€»è¾‘ä»æ˜¯**å•çº¿ç¨‹**çš„ï¼š

- æ‰€æœ‰ `GET`, `SET`, `ZADD`, `HGET` ç­‰å‘½ä»¤éƒ½åœ¨ä¸»çº¿ç¨‹é¡ºåºæ‰§è¡Œï¼›
- ä¸å­˜åœ¨é”ç«äº‰ï¼Œä¹Ÿä¸éœ€è¦ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼›
- å› æ­¤éå¸¸å¿«ï¼ˆå†…å­˜æ“ä½œ + äº‹ä»¶å¾ªç¯ï¼‰ã€‚

ğŸ’¡ è¿™æ­£æ˜¯ Redis èƒ½åœ¨ç™¾ä¸‡ QPS åœºæ™¯ä¸‹ä»ç„¶ç¨³å®šçš„åŸå› ã€‚

## ä¸ºä»€ä¹ˆä½¿ç”¨å•çº¿ç¨‹ï¼Ÿ

å› ä¸º

Redis çš„æ•°æ®ç»“æ„ï¼ˆhashã€zsetã€listã€dictï¼‰æ“ä½œéœ€è¦ä¿æŒåŸå­æ€§ï¼›

å¤šçº¿ç¨‹åŒæ—¶æ“ä½œç›¸åŒ key ä¼šäº§ç”Ÿé”ç«äº‰ï¼›

å¤šçº¿ç¨‹ä¸‹éš¾ä»¥ä¿è¯å‘½ä»¤é—´é¡ºåºä¸€è‡´æ€§ï¼›

å•çº¿ç¨‹ + I/O å¤šçº¿ç¨‹ æ˜¯ä¸€ä¸ªæ€§èƒ½ä¸ä¸€è‡´æ€§çš„æœ€ä½³å¹³è¡¡ç‚¹ã€‚

## ç½‘ç»œIOå¤šçº¿ç¨‹

Redis6.0å‰ï¼Œå®Œå…¨å•çº¿ç¨‹å¾ªç¯çš„äº‹ä»¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     å•çº¿ç¨‹äº‹ä»¶å¾ªç¯   â”‚
â”‚--------------------â”‚
â”‚ epoll_wait()ç­‰å¾…äº‹ä»¶â”‚
â”‚ å¤„ç†è¯»äº‹ä»¶          â”‚
â”‚ æ‰§è¡Œå‘½ä»¤ï¼ˆå†…å­˜æ“ä½œï¼‰  â”‚
â”‚ å¤„ç†å†™äº‹ä»¶          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

```

ä¹Ÿå°±æ˜¯è¯´ï¼š

- Redis ä¸»çº¿ç¨‹é€šè¿‡ **epoll_wait()** è·å–æ´»è·ƒè¿æ¥ï¼›
- ç„¶åé¡ºåºæ‰§è¡Œæ‰€æœ‰çš„è¯»ã€å‘½ä»¤ã€å†™é€»è¾‘ï¼›
- æ•´ä¸ªè¿‡ç¨‹å…¨åœ¨ä¸€ä¸ª CPU æ ¸ä¸Šå®Œæˆã€‚

ğŸ’¡ é«˜æ•ˆæ˜¯å› ä¸ºï¼š

- ä¸ç”¨åŠ é”
- ä¸ç”¨ä¸Šä¸‹æ–‡åˆ‡æ¢
- å†…å­˜æ“ä½œæå¿«

è€Œåœ¨Redis6.0ä¹‹åï¼Œå¼•å…¥äº†IOå¤šçº¿ç¨‹ï¼Œepoll ä»ç„¶è´Ÿè´£äº‹ä»¶ç›‘å¬ï¼›
 ä½†ç½‘ç»œè¯»å†™ç”±å¤šä¸ªçº¿ç¨‹å¹¶å‘å®Œæˆã€‚

```
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚          ä¸»çº¿ç¨‹            â”‚
         â”‚---------------------------â”‚
         â”‚ epoll_wait() è·å–æ´»è·ƒsocketâ”‚
         â”‚ å°†socketåˆ†å‘ç»™I/Oçº¿ç¨‹æ±      â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                   â”‚                   â”‚
  v                   v                   v
I/Oçº¿ç¨‹1           I/Oçº¿ç¨‹2           I/Oçº¿ç¨‹3
(è¯»å–socketæ•°æ®)  (è§£æè¯·æ±‚åŒ…)      (å†™å›å“åº”ç»“æœ)

```

epoll ä»ç„¶åœ¨ä¸»çº¿ç¨‹ä¸­ä½¿ç”¨ï¼›

ä¸»çº¿ç¨‹æ”¶é›†æ´»è·ƒè¿æ¥åï¼Œå°†è¿™äº›è¿æ¥åˆ†é…ç»™å¤šä¸ª I/O çº¿ç¨‹ï¼›

å„çº¿ç¨‹è´Ÿè´£å¹¶è¡Œ read()/write()ï¼›

å‘½ä»¤è§£æä¸æ‰§è¡Œä»ç„¶åœ¨ä¸»çº¿ç¨‹å®Œæˆã€‚

## å¼‚æ­¥åˆ é™¤å¤šçº¿ç¨‹ï¼ˆæ‡’åˆ é™¤lazy freeï¼‰

**åœºæ™¯ï¼š**
 å‘½ä»¤å¦‚ `UNLINK`, `FLUSHDB ASYNC`, `FLUSHALL ASYNC` åˆ é™¤å¤§é‡é”®æ—¶ï¼Œå¦‚æœåœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œä¼šé˜»å¡æ•´ä¸ªå®ä¾‹ã€‚

**è§£å†³ï¼š**
 Redis ä½¿ç”¨**åå°çº¿ç¨‹æ± **å¼‚æ­¥é‡Šæ”¾å†…å­˜ã€‚

é¿å…ä¸»çº¿ç¨‹é˜»å¡



## AOF/RDB

| åœºæ™¯                     | çº¿ç¨‹              | è¯´æ˜                           |
| ------------------------ | ----------------- | ------------------------------ |
| AOF é‡å†™ï¼ˆBGREWRITEAOFï¼‰ | å­è¿›ç¨‹ + I/O çº¿ç¨‹ | å¼‚æ­¥é‡å†™æ—¥å¿—æ–‡ä»¶               |
| RDB å¿«ç…§ï¼ˆBGSAVEï¼‰       | å­è¿›ç¨‹            | å¼‚æ­¥å†™å…¥ RDB æ–‡ä»¶              |
| AOF fsync                | åå°çº¿ç¨‹          | å®šæœŸå°† AOF buffer flush åˆ°ç£ç›˜ |

## é›†ç¾¤å’Œå¤åˆ¶çº¿ç¨‹

- Redis Cluster èŠ‚ç‚¹ä¹‹é—´çš„ **gossip æ¶ˆæ¯**ã€**replica åŒæ­¥** ç­‰ç½‘ç»œé€šä¿¡ä¹Ÿé€šè¿‡ç‹¬ç«‹çº¿ç¨‹å¤„ç†ï¼›

- å¤åˆ¶æ—¶ï¼Œ**ä¸»èŠ‚ç‚¹å‘é€ RDB æ–‡ä»¶** æ˜¯åœ¨åå°å­è¿›ç¨‹ä¸­å®Œæˆï¼›

- åœ¨ Redis 7+ ä¸­å¼•å…¥äº† **I/O thread per connection** çš„å¤åˆ¶æœºåˆ¶ã€‚

# å“¨å…µæ¨¡å¼

# é›†ç¾¤æ¨¡å¼

