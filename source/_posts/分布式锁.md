---
title: 分布式锁
date: 2025-09-22 03:22:40
tags:
  - 分布式
---

# 分布式理论/协议/算法基础

## CAP理论

**CAP** 也就是 **Consistency（一致性）**、**Availability（可用性）**、**Partition Tolerance（分区容错性）** 这三个单词首字母组合。

**一致性（Consistency）** : 所有节点访问同一份最新的数据副本

**可用性（Availability）**: 非故障的节点在合理的时间内返回合理的响应（不是错误或者超时的响应）。

**分区容错性（Partition Tolerance）** : 分布式系统出现网络分区的时候，仍然能够对外提供服务。

>• consistency (C) equivalent to having a single up-to-date copy of the data;
>• high availability (A) of that data (for updates); and
>• tolerance to network partitions (P).

CAP理论并不是3选2的选择题，而是AP和CP中选择：

**当发生网络分区的时候，如果我们要继续服务，那么强一致性和可用性只能 2 选 1。也就是说当网络分区之后 P 是前提，决定了 P 之后才有 C 和 A 的选择。也就是说分区容错性（Partition tolerance）我们是必须要实现的。**

简而言之就是：CAP 理论中分区容错性 P 是一定要满足的，在此基础上，只能满足可用性 A 或者一致性 C。

CAP实际上只禁止了一种极端情况：当发生分区时，系统不可能保证一致性和可用性，但是实际上网络分区在真实网络中相对少见，大多数情况下网络是能够满足强一致性和可用性的。

理解 CAP 最简单的方法是：想象两个节点被网络分区隔开在两边。
 如果允许至少一个节点继续更新状态，那么节点之间就会出现不一致，从而放弃了一致性（C）。
 相反，如果选择保持一致性，那么分区的一侧必须表现得像是不可用，从而放弃了可用性（A）。
 只有在节点之间能够通信时，才能同时保持一致性和可用性，而这意味着放弃了分区容忍性（P）。
 普遍的看法是，对于广域系统（wide-area systems），设计者无法放弃 P，因此只能在一致性（C）和可用性（A）之间做出艰难的选择。
 从某种意义上说，NoSQL 设计的核心就是在设计时优先考虑可用性，其次才是一致性；而遵循 ACID 特性的数据库（原子性、一致性、隔离性、持久性）则恰好相反。





## ACID/BASE和CAP

ACID的设计是单机型数据库的设计原则，为了保证数据的强一致性，而BASE理论则是分布式系统/数据库设计原则，为了保证数据的高可用和高扩展，允许数据的短暂不一致，只需要保证最终一致性即可。

### ACID

ACID 是数据库事务的四个关键特性，保证了数据操作的 **可靠性**。
 它分别是：**原子性 (Atomicity)、一致性 (Consistency)、隔离性 (Isolation)、持久性 (Durability)**。

1. 原子性：事务中的所有操作要么全部成功要么全部不成功，通常采用Undo Log实现，来回滚失败的事务。
2. 一致性：事务执行前后，数据库必须从一个 **一致状态** 转换到另一个 **一致状态**。所有数据必须满足数据库定义的约束（如主键唯一、外键约束、触发器、检查约束等）。假设数据库要求账户余额不能为负数，那么事务执行结束后，必须仍然满足这个规则。
3. 隔离性：多个事务同时执行，每个事务应该是隔离的，数据库有不同的隔离等级。

- 读未提交
- 读已提交->解决脏读
- 可重复读->解决不可重复度
- 串行化->解决幻读

4. 持久性：一旦事务提交成功，它对数据库的修改就是永久性的，即使系统崩溃也不会丢失。实现方式：数据库通常通过 **WAL（Write Ahead Log，预写日志）** 或 **Redo Log** 来保证。

## Zookeeper

Zookeeper保证的是**CP**，使用**ZAB协议**。任何时刻对Zookeeper的请求都会保证一致性，假设一种情况有Zookeeper集群有5个节点，发生网络分区，分为3个和2个，两个子集不能相通信。此时：

- 3 个节点组成 **多数派** → 继续提供服务

- 2 个节点组成 **少数派** → 不提供服务

如果有节点连接到了多数派，Zookeeper节点正常提供服务，如果有其他服务连到了少数派，则Zookeeper节点会挂起。

## Eureka

**Eureka 保证的则是 AP。** Eureka 在设计的时候就是优先保证 A （可用性）。在 Eureka 中不存在什么 Leader 节点，每个节点都是一样的、平等的。因此 Eureka 不会像 ZooKeeper 那样出现选举过程中或者半数以上的机器不可用的时候服务就是不可用的情况。 Eureka 保证即使大部分节点挂掉也不会影响正常提供服务，只要有一个节点是可用的就行了。只不过这个节点上的数据可能并不是最新的。



## Nacos

nacos不仅支持AP也支持CP



## PAXOS协议



## RAFT协议



## ZAB协议

